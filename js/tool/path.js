define(["knockout","draw","text!view/path.svg"],function(e,t,n){var o,i,l,r,c,a=e.computed(function(){if(t.tool()&&t.tool()._path)return _(t.selection()).chain().filter(function(e){return"path"==e.type&&e.getLastPoint()&&0==e.rotate()}).map(function(e){var n=t.toView(e.getLastPoint());return n._selector=!0,n.shape=e,n}).value()}),u=e.observable(),s=e.observable(),p=e.observable(),b=e.observable(),f=function(e){return c=e,r=!0,c._center&&o.back(),e._selector},d=function(e){c._begin&&o?s(o.getFirstPoint()):c._center||s(t.fromView(e.start)),o||(i=null,c._selector?(o=c.shape,s(o.getLastPoint())):(o=t.layer().newShape("path"),o.set(t.options),o.moveTo(s())),u(o.getFirstPoint()))},v=function(e){if(o&&!c._center){var n=t.fromView(e.position),r=s();i&&(l={x:2*r.x-n.x,y:2*r.y-n.y},o.back(),o.curveTo(i,l,r),b(l)),p(n)}},w=function(e){d(e),o&&!c._center&&(i&&(o.back(),o.curveTo(i,s(),s())),p(t.fromView(e.position)),b(null))},h=function(){r=!1,t.deselect(),o&&(c._center?(t.select(o),g(!0)):c._begin?(o.close(),t.select(o),g(!0)):(o.lineTo(s()),i=p()))},g=function(e){!e&&o&&(t.deselect(),o.visible(!1)),e&&o&&t.save(o),o=null,i=null,p(null),b(null),s(null),u(null)},m=e.computed(function(){var e=[],n=t.toView(p()),o=t.toView(b()),i=t.toView(s());return n&&e.push(n.x,n.y),i&&e.push(i.x,i.y),o&&e.push(o.x,o.y),e.join(" ")});return{name:"Path Tool",iconView:'<span class="draw-icon-path"></span>',view:n,_path:!0,check:f,center:e.computed(_(t.toView).bind(null,s,"_center")),begin:e.computed(_(t.toView).bind(null,u,"_begin")),control1:e.computed(_(t.toView).bind(null,p,"_control1")),control2:e.computed(_(t.toView).bind(null,b,"_control2")),cpoints:m,selectors:a,dragstart:d,drag:v,tap:w,hold:w,release:h,off:g}});