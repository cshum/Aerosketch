define(["underscore","draw"],function(t,i){return function(a,r){var e,n,o;"rotate"in r&&(o=r.rotate*Math.PI/180,e=Math.sin(o),n=Math.cos(o)),t(a).each(function(a){var o=t(a.bbox()).clone(),h=a.rotate();if("translate"in r&&(o.x+=r.translate.x,o.y+=r.translate.y),"scale"in r&&(o.width*=Math.abs(r.scale),o.height*=Math.abs(r.scale),r.scale<0&&(o.x-=o.width,o.y-=o.height),o.x=r.origin.x+(o.x-r.origin.x)*r.scale,o.y=r.origin.y+(o.y-r.origin.y)*r.scale),"rotate"in r){o.x-=r.origin.x-o.width/2,o.y-=r.origin.y-o.height/2;var s=o.x,d=o.y;o.x=s*n-d*e,o.y=s*e+d*n,o.x+=r.origin.x-o.width/2,o.y+=r.origin.y-o.height/2,h+=r.rotate}h=Math.round(10*h)/10,o.x=i.round(o.x),o.y=i.round(o.y),o.width=i.round(o.width),o.height=i.round(o.height),a.bbox(o),a.rotate(h),r.scale&&a.strokeWidth(Math.round(a.strokeWidth()*r.scale*100)/100)})}});