define(["knockout","underscore","shape/template"],function(t,i,h){var n=function(){var t=function(i,h){if(1==i.length)return i[0];for(var n=[],s=0;s<i.length-1;s++)n.push([i[s][0]+(i[s+1][0]-i[s][0])*h,i[s][1]+(i[s+1][1]-i[s][1])*h]);return t(n,h)};return function(i,h){for(var n=[],s=0;s<=h;s++)n.push(t(i,s/h));return n}}(),s=function(t,i){var h=i[0],n=i[1];return t?{x1:Math.min(h,t.x1),x2:Math.max(h,t.x2),y1:Math.min(n,t.y1),y2:Math.max(n,t.y2),point:i}:{x1:h,x2:h,y1:n,y2:n,point:i}},a={read:function(){this.currPath!=this.path()&&(this.bounds=[],this.currPath=this.path());for(var t=this.path(),h=this.bounds,a=h.length,e=t.length,r=a;r<e;r++){var o=r>0?h[r-1]:null;switch(t[r][0]){case"M":case"L":o=s(o,t[r][1]);break;case"C":case"Q":i(n([o.point].concat(i(t[r]).tail()),20)).each(function(t){o=s(o,t)})}h.push(o)}if(h.length>0){var u=i(h).last();return{x:u.x1,y:u.y1,width:u.x2-u.x1,height:u.y2-u.y1}}return null},write:function(t){if(this.path().length>0){var h=this.bbox();i(t).defaults(h);var n=0!==h.width?t.width/h.width:1,s=0!==h.height?t.height/h.height:1,a=t.x-h.x,e=t.y-h.y;i(this.path()).each(function(t){i(t).each(function(t,r){i.isArray(t)&&(t[0]=h.x+a+(t[0]-h.x)*n,t[1]=h.y+e+(t[1]-h.y)*s)})}),this.bounds=[],this.path.valueHasMutated()}}},e=function(){return this.path().length>0?i(this.path()).flatten().join(" "):"M 0 0"},r=function(){this.path.push(i(arguments).map(function(t){return i.isObject(t)?[t.x,t.y]:t}))},o=function(){if(this.path().length>0)return this.bounds.pop(),this.path.pop()},u=function(){this.path([])},c=function(t){var i=this.bounds[t].point;return{x:i[0],y:i[1]}},p=function(){if(this.path().length>0&&"Z"!=i(this.path()).last()[0])return c.call(this,this.bounds.length-1)};return h("path",function(){this.path=t.observableArray([]),this.d=t.computed(e,this),this.bounds=[],this.bbox=t.computed(a,this),this.moveTo=i(r).bind(this,"M"),this.lineTo=i(r).bind(this,"L"),this.curveTo=i(r).bind(this,"C"),this.qCurveTo=i(r).bind(this,"Q"),this.close=i(r).bind(this,"Z"),this.back=i(o).bind(this),this.clear=i(u).bind(this),this.getPointAt=i(c).bind(this),this.getLastPoint=i(p).bind(this),this.getFirstPoint=i(c).bind(this,0)},{attr:["d"],options:["path"]})});