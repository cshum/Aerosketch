define(["knockout","underscore","underscore.string"],function(t,o,e){return function(i,s,r){var n=["fill","stroke","strokeWidth","transform"].concat(r.attr),a=["fill","stroke","strokeWidth","rotate","visible"].concat(r.options),h=function(r){var h=this;s.call(h),h.fill=t.observable(),h.stroke=t.observable(),h.strokeWidth=t.observable(),h._destroy=t.observable(!1);var c=t.observable(0);h.rotate=t.computed({read:c,write:function(t){for(;t<0;)t+=360;c(t%360)}}),h.transform=t.computed(d,h),h.visible=t.observable(!0),h._shape=!0,h.type=i,h.attr={},o(n).each(function(t){h.attr[e.dasherize(t)]=h[t]}),h.options={},o(a).each(function(t){h.options[t]=h[t]}),h.record=r||{visible:!1},h.delta=t.observable({}),h.redos=[],h.undos=[],h.set(r||{})},c=function(e){var i=this;o(t.toJS(e||{})).each(function(t,e){e in i.options&&!o.isEqual(i[e](),t)&&i[e](t)})},u=function(){var o=t.toJS(this.options);return o.type=i,o},d=function(){if(0!==this.rotate()){var t=this.bbox();if(t&&"x"in t&&"width"in t)return"rotate("+this.rotate()+" "+(t.x+t.width/2)+","+(t.y+t.height/2)+")"}},l=function(){var e={},i=this.record,s={};o(this.options).each(function(r,n){var a=t.toJS(r());o.isEqual(i[n],a)||(n in i&&(e[n]=i[n]),s[n]=a,i[n]=a)}),this.delta(s),this.undos.push(e),this.redos=[]},f=function(t,e){if(0!==t.length){var i=t.pop();e.push(o(this.record).pick(o(i).keys())),this.set(i),this.delta(i),o(this.record).extend(i)}},v=function(){f.call(this,this.undos,this.redos)},b=function(){f.call(this,this.redos,this.undos)};return o(h.prototype).extend({set:c,get:u,save:l,undo:v,redo:b}),h}});