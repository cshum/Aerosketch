define(["knockout","underscore","transform","draw","util/kosvgtemplate","text!view/selected.svg","util/requestanimationframe"],function(t,e,n,o,i,r,a){var s,l,c,u,f,d=i(o.selection,function(t){return t.view||"<"+t.type+' data-bind="aniattr:attr" />'}),m=function(t){var e=t.bbox(),n=t.rotate(),i="none"!=t.stroke()?t.strokeWidth()*o.zoom():0,r=o.toView(e);return r.transform="rotate("+n+" "+(r.x+r.width/2)+","+(r.y+r.height/2)+")",r.style=null,r.x-=i/2+1,r.y-=i/2+1,r.width+=i+2,r.height+=i+2,r},g=function(t){var n=e(o.selection()).contains(t);return n||o.deselect(),n},v=!1,b=t.observable({}),h=function(){l=1,s=null,v||(v=!0,o.transforming(!0),u=e(o.selection()).clone(),c=e(u).map(function(t){return t.visible()}),e(u).invoke("visible",!1))},w=function(t){s||(s=t.angle),b(t.shiftKey||2==t.button?{rotate:t.angle-s,origin:o.fromView(t.start)}:{translate:{x:t.distanceX/o.zoom(),y:t.distanceY/o.zoom()}})},y=function(t){b({origin:o.fromView(t.position),rotate:t.rotation,scale:t.scale,translate:{x:t.distanceX/o.zoom(),y:t.distanceY/o.zoom()}})},x=function(t){v||(f=o.fromView(t.position),h()),l*=1+t.delta,b({origin:f,scale:l})};return o.debounce.subscribe(function(t){!t&&v&&(n(u,b()),a(function(){v=!1,o.transforming(!1),e(u).each(function(t,e){t.visible(c[e])}),o.save.apply(null,u),b({})}))}),{check:g,dragstart:h,transformstart:h,transform:y,drag:w,buffer:t.computed(function(){var t="",e=b();return e.origin&&(t+="translate("+e.origin.x+","+e.origin.y+") "),e.rotate&&(t+="rotate("+e.rotate+")"),e.scale&&(t+="scale("+e.scale+")"),e.origin&&(t+="translate("+-e.origin.x+","+-e.origin.y+") "),e.translate&&(t+="translate("+e.translate.x+","+e.translate.y+") "),t}),wheel:x,view:r,selectedBBox:m,selectedTemplate:d}});