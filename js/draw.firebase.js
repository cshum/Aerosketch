define(["knockout","underscore","draw","layer","shape/factory","util/requestanimationframe","util/deferbuffer","points","http://static.firebase.com/v0/firebase.js","https://cdn.firebase.com/v0/firebase-auth-client.js"],function(e,i,n,a,t,s,o,r){var c=new Firebase("https://aerosketch.firebaseio.com/"),l=c.child("surfaces"),d=c.child("surfacesMeta"),u=c.child("users"),h=e.observable(),f=e.observable(),b=e.observable(),v=new FirebaseAuthClient(c,function(e,i){h(i),i&&u.child(i.id).set(i)}),y=function(){f(l.push({layers:{default:{visible:!0,name:"Default Layer",shapes:[{type:"path",visible:!1}]}}}).name())},m=function(){v.login("facebook",{rememberMe:!0,scope:"email"})},p=function(){v.logout()},x=i.once(function(e){var c=d.child(f()).child("title"),u=l.child(f()),h={},v=u.child("layers"),y=o(),m={},p=!1,x=i.once(function(){p=!0,"x1"in m?e({x:m.x1,y:m.y1,width:m.x2-m.x1,height:m.y2-m.y1}):e()});c.on("value",function(e){b(e.val())}),b.subscribe(i(c.set).bind(c)),v.on("child_added",function(e){var o=e.name(),c=h[o]||new a,l=v.child(o),d={},u=l.child("shapes");h[o]=c,u.on("child_added",function(e){y(function(){var n=e.name(),a=e.val(),o=u.child(n),l=d[n]||t(a.type,a);if(d[n]=l,o.on("value",function(e){l.set(e.val())}),l.delta.subscribe(i(o.update).bind(o)),l._destroy.subscribe(function(e){e&&o.remove()}),!p&&l.visible()){var h="none"!=l.stroke()?l.strokeWidth():0;i(r(l)).each(function(e){m.x1=Math.min(e.x-h/2,m.x1||e.x-h/2),m.y1=Math.min(e.y-h/2,m.y1||e.y-h/2),m.x2=Math.max(e.x+h,m.x2||e.x+h),m.y2=Math.max(e.y+h,m.y2||e.y+h)})}c.shapes.push(l),p||s(x)})}),u.on("child_removed",function(e){var i=d[e.name()];i.visible(!1),i._destroy(!0),delete d[e.name()]}),c.newShape=function(e){var i=t(e),n=u.push({type:e});return i.layer=c,d[n.name()]=i,i},n.layers.push(c),d[o]=c,n.layer(c)}),v.on("child_removed",function(e){var i=h[e.name()];i.visible(!1),i._destroy(!0),delete h[e.name()]})});i(n).extend({id:f,user:h,title:b,load:x,create:y,login:m,logout:p})});