define(["knockout","underscore","util/kotemplate","util/kosvgtemplate","layer"],function(e,t,r,o,n){var i=e.observableArray(),a=e.observable(),l=function(e){var t=Math.ceil(Math.log(b())/Math.LN10);return parseFloat(e.toFixed(Math.max(1,t)))},u=function(t,r){if(t=e.utils.unwrapObservable(t)){var o=s(),n=b(),i={};return"x"in t&&(i.x=t.x*n-o.x),"y"in t&&(i.y=t.y*n-o.y),"width"in t&&(i.width=t.width*n),"height"in t&&(i.height=t.height*n),r&&(i[r]=!0),i}},c=function(t,r){if(t=e.utils.unwrapObservable(t)){var o=s(),n=b(),i={};return"x"in t&&(i.x=l((o.x+t.x)/n)),"y"in t&&(i.y=l((o.y+t.y)/n)),"width"in t&&(i.width=l(t.width/n)),"height"in t&&(i.height=l(t.height/n)),r&&(i[r]=!0),i}},s=e.observable({x:0,y:0}),b=e.observable(1),h=e.observable("white"),v=e.computed(function(){var e=s(),t=b();return"translate("+-e.x+" "+-e.y+") scale("+t+")"}),f=e.observableArray([]),w=function(){f.removeAll()},d=function(){f(t(arguments).toArray())},m=e.observableArray(),y=o(e.computed(function(){return m.slice(0).reverse()}),function(e){return e&&e.view?e.view:""}),g=e.observable(),p=function(){var t=e.observable();return e.computed({read:t,write:function(e){t()&&t().off&&t().off(),t(e),t()&&t().on&&t().on()}})}(),x=e.observableArray(),k=o(p,function(e){return e&&e.view?e.view:""}),A=r(p,function(e){return e&&e.toolbarView?e.toolbarView:""}),T=e.observable(!1),F=e.observable(!1),M=function(){var r,o;return function(n,i){function a(t){return"check"in t&&t.check(e.dataFor(i.target))}n.match(/touch|wheel/)&&!T()&&(r=a(p())?p():t(m()).find(a)||p(),T(!0)),"release"==n?T(!1):"wheel"==n?(clearTimeout(o),o=setTimeout(T,250,!1)):n.match(/start/)&&clearTimeout(o),r&&t.isFunction(r[n])?r[n](i):g()&&t.isFunction(g()[n])&&g()[n](i)}}();return{layers:i,layer:a,round:l,fromView:c,toView:u,zoom:b,position:s,transform:v,background:h,selection:f,select:d,deselect:w,trigger:M,debounce:T,transforming:F,tools:x,tool:p,toolTemplate:k,toolbarTemplate:A,controls:m,baseControl:g,controlsTemplate:y}});